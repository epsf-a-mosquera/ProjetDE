###########################################################
# Docker Compose - ProjetDE (complet & commenté)
# Description :
# Microservices pour scraping, parsing, ingestion DB,
# entraînement ML et API. Tous les services sont inclus
# avec des volumes locaux pour persistance.
###########################################################

version: '3.9'

services:

  ###########################################################
  # PostgreSQL : base de données locale
  # Persistance via bind mount (./postgres_data)
  ###########################################################
  postgres:
    image: postgres:15
    container_name: projetde_postgres
    environment:
      POSTGRES_DB: DB_ERATV
      POSTGRES_USER: guest
      POSTGRES_PASSWORD: guest
    ports:
      - "5432:5432"
    volumes:
      - ./postgres_data:/var/lib/postgresql/data   # persistance locale
      - ./db/init:/docker-entrypoint-initdb.d      # scripts SQL init DB

  ###########################################################
  # pgAdmin : interface web PostgreSQL
  ###########################################################
  pgadmin:
    image: dpage/pgadmin4
    container_name: projetde_pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "5050:80"  # accès web via http://localhost:5050

  ###########################################################
  # RabbitMQ : broker de messages avec interface de management
  ###########################################################
  rabbitmq:
    image: rabbitmq:3-management
    container_name: projetde_rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    ports:
      - "5672:5672"    # communication microservices
      - "15672:15672"  # interface web RabbitMQ, accès web via http://localhost:15672
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  ###########################################################
  # Scraper liste HTML : récupère la liste complète en CSV
  # et envoie un message dans csv_list.queue
  ###########################################################
  scraper_liste_html:
    build: ./scraper_liste_html
    container_name: projetde_scraper_liste_html
    depends_on:
      - rabbitmq
    environment:
      RABBITMQ_HOST: rabbitmq
      QUEUE_NAME: csv_list.queue
    volumes:
      - ./data/csv_listes:/app/data/csv_listes  # CSV générés par ce service

  ###########################################################
  # Parser liste CSV : lit CSV, compare avec DB, envoie
  # URL des véhicules nouveaux/modifiés dans vehicle_pages.queue
  ###########################################################
  parser_liste_csv:
    build: ./parser_liste_csv
    container_name: projetde_parser_liste_csv
    depends_on:
      - rabbitmq
      - postgres
    environment:
      RABBITMQ_HOST: rabbitmq
      QUEUE_IN: csv_list.queue
      QUEUE_OUT: vehicle_pages.queue
      DB_HOST: postgres
      DB_NAME: DB_ERATV
      DB_USER: guest
      DB_PASS: guest
      DATA_DIR: /app/data/csv_listes  # dossier où les CSV sont stockés
    volumes:
      - ./data/csv_listes:/app/data/csv_listes  # partagé avec scraper_liste_html

  ###########################################################
  # Scraper HTML type véhicule : récupère page véhicule,
  # extrait lien XML et publie dans xml_vehicle.queue
  ###########################################################
  scraper_type_vehicule_html:
    build: ./scraper_type_vehicule_html
    container_name: projetde_scraper_type_vehicule_html
    depends_on:
      - rabbitmq
    environment:
      RABBITMQ_HOST: rabbitmq
      QUEUE_IN: vehicle_pages.queue
      QUEUE_OUT: xml_vehicle.queue
    volumes:
      - ./data/xml_types_vehicules:/app/data/xml_types_vehicules  # stockage XML détaillés

  ###########################################################
  # Parser XML type véhicule : parse XML et publie données structurées
  ###########################################################
  parser_type_vehicule_xml:
    build: ./parser_type_vehicule_xml
    container_name: projetde_parser_type_vehicule_xml
    depends_on:
      - rabbitmq
    environment:
      RABBITMQ_HOST: rabbitmq
      QUEUE_IN: xml_vehicle.queue
      QUEUE_OUT: parsed.queue
    volumes:
      - ./data/xml_types_vehicules:/app/data/xml_types_vehicules

  ###########################################################
  # Ingest : insère / met à jour les données dans PostgreSQL
  ###########################################################
  ingest:
    build: ./ingest
    container_name: projetde_ingest
    depends_on:
      - rabbitmq
      - postgres
    environment:
      RABBITMQ_HOST: rabbitmq
      QUEUE_IN: parsed.queue
      DB_HOST: postgres
      DB_NAME: DB_ERATV
      DB_USER: guest
      DB_PASS: guest
    volumes:
      - ./data/xml_listes:/app/data/xml/listes
      - ./data/xml_types_vehicules:/app/data/xml_types_vehicules

  ###########################################################
  # Scheduler : planifie scraping & entraînements ML
  ###########################################################
  scheduler:
    build: ./scheduler
    container_name: projetde_scheduler
    depends_on:
      - scraper_liste_html
      - scraper_type_vehicule_html
      - ml_trainer
      - rabbitmq
    environment:
      RABBITMQ_HOST: rabbitmq

  ###########################################################
  # ML Trainer : entraîne le modèle sur la DB
  ###########################################################
  ml_trainer:
    build: ./ml_trainer
    container_name: projetde_ml_trainer
    depends_on:
      - postgres
    environment:
      DB_HOST: postgres
      DB_NAME: DB_ERATV
      DB_USER: guest
      DB_PASS: guest
    volumes:
      - ./models:/app/models  # stockage modèle entraîné

  ###########################################################
  # ML API : expose le modèle pour prédictions
  ###########################################################
  ml_api:
    build: ./ml_api
    container_name: projetde_ml_api
    depends_on:
      - ml_trainer
    environment:
      MODEL_PATH: /app/models/model.pkl
    ports:
      - "8500:8500"
    volumes:
      - ./models:/app/models

  ###########################################################
  # API REST : expose les données de la DB
  ###########################################################
  api:
    build: ./api
    container_name: projetde_api
    depends_on:
      - postgres
    environment:
      DB_HOST: postgres
      DB_NAME: DB_ERATV
      DB_USER: guest
      DB_PASS: guest
    ports:
      - "8000:8000"

###########################################################
# Notes volumes :
# - ./data/csv_listes : CSV générés par scraper_liste_html
# - ./data/xml_types_vehicules : XML détaillés
# - ./postgres_data : persistance PostgreSQL
# - ./models : modèles ML sauvegardés
# Bind mounts permettent portabilité et accès direct
###########################################################

# Aucun volume nommé utilisé ici : tout est bind mount
