###########################################################
# Docker Compose - ProjetDE (complet & portable)
# Description générale :
# Ce projet comprend plusieurs microservices pour le scraping,
# parsing, ingestion dans une DB, entraînement ML et API.
# Tous les services principaux sont inclus ici avec des
# volumes locaux pour persistance.
###########################################################

services:

  ###########################################################
  # PostgreSQL : base de données locale
  # Persistance via volume bind pour portabilité (./postgres_data)
  ###########################################################
  postgres:
    image: postgres:15  # Image officielle PostgreSQL version 15
    container_name: projetde_postgres  # Nom du conteneur pour facilité la gestion
    environment:  # Variables d'environnement pour config DB
      POSTGRES_DB: DB_type_vehicule  # Nom de la base créée par défaut
      POSTGRES_USER: guest  # Utilisateur principal
      POSTGRES_PASSWORD: guest  # Mot de passe associé
    ports:
      - "5432:5432"  # Expose le port local 5432 vers le conteneur
    volumes:
      - ./postgres_data:/var/lib/postgresql/data  # Stockage persistant local, permet portabilité

  ###########################################################
  # RabbitMQ : broker de messages avec interface de management
  ###########################################################
  rabbitmq:
    image: rabbitmq:3-management
    container_name: projetde_rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    ports:
      - "5672:5672"
      - "15672:15672"
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  ###########################################################
  # Scraper liste HTML : récupère la liste en CSV
  # Stocke un csv dans ./data/csv_listes
  ###########################################################
  scraper_liste_html:
    build: ./scraper_liste_html  # Dockerfile local pour le service
    container_name: projetde_scraper_liste_html
    depends_on:
      - rabbitmq  # juste dépendance normale
    environment:
      RABBITMQ_HOST: rabbitmq  # Nom du service RabbitMQ (réseau interne)
      QUEUE_NAME: csv_list.queue  # Queue utilisée pour publier la liste csv
    volumes:
      - ./data/csv_listes:/app/data  # Stockage local des CSV de listes

  ###########################################################
  # Parser liste CSV : analyse les CSV téléchargés
  # Compare avec DB et envoie jobs pour types de véhicules
  ###########################################################
  parser_liste_csv:
    build: ./parser_liste_csv
    container_name: projetde_parser_liste_csv
    depends_on:
      - rabbitmq
      - postgres
    environment:
      RABBITMQ_HOST: rabbitmq
      QUEUE_IN: csv_list.queue      # Consomme la liste CSV
      QUEUE_OUT: vehicle_pages.queue  # Publie les url pour les pages de type véhicule à scraper
      DB_HOST: postgres
      DB_NAME: scraping
      DB_USER: scrape
      DB_PASS: scrape
    volumes:
      - ./data/xml_listes:/app/data/xml/listes  # Accès aux fichiers XML

  ###########################################################
  # Scraper HTML type véhicule : récupère page véhicule,
  # extrait le lien du XML détaillé et publie la tâche
  ###########################################################
  scraper_type_vehicule_html:
    build: ./scraper_type_vehicule_html
    container_name: projetde_scraper_type_vehicule_html
    depends_on:
      - rabbitmq
    environment:
      RABBITMQ_HOST: rabbitmq
      QUEUE_IN: vehicle_pages.queue  # Consomme les jobs de parser_liste_xml
      QUEUE_OUT: xml_vehicle.queue   # Publie jobs pour parser_type_vehicule_xml
    volumes:
      - ./data/xml_types_vehicules:/app/data/xml/types_vehicules  # Stockage local des XML

  ###########################################################
  # Parser XML type véhicule : parse XML détaillé,
  # sauvegarde et publie les données structurées
  ###########################################################
  parser_type_vehicule_xml:
    build: ./parser_type_vehicule_xml
    container_name: projetde_parser_type_vehicule_xml
    depends_on:
      - rabbitmq
    environment:
      RABBITMQ_HOST: rabbitmq
      QUEUE_IN: xml_vehicle.queue
      QUEUE_OUT: parsed.queue
    volumes:
      - ./data/xml_types_vehicules:/app/data/xml/types_vehicules

  ###########################################################
  # Ingest : insère / met à jour les données dans PostgreSQL
  ###########################################################
  ingest:
    build: ./ingest
    container_name: projetde_ingest
    depends_on:
      - rabbitmq
      - postgres
    environment:
      RABBITMQ_HOST: rabbitmq
      QUEUE_IN: parsed.queue  # Consomme les données structurées
      DB_HOST: postgres
      DB_NAME: scraping
      DB_USER: scrape
      DB_PASS: scrape
    volumes:
      - ./data/xml_listes:/app/data/xml/listes     # Optionnel, référence
      - ./data/xml_types_vehicules:/app/data/xml/types_vehicules

  ###########################################################
  # Scheduler : planifie scraping & entraînements ML
  ###########################################################
  scheduler:
    build: ./scheduler
    container_name: projetde_scheduler
    depends_on:
      - scraper_liste_html
      - scraper_type_vehicule_html
      - ml_trainer
      - rabbitmq
    environment:
      RABBITMQ_HOST: rabbitmq
      # Queues et intervals à config via variables si besoin

  ###########################################################
  # ML Trainer : entraîne le modèle sur la DB
  # Sauvegarde dans /app/models
  ###########################################################
  ml_trainer:
    build: ./ml_trainer
    container_name: projetde_ml_trainer
    depends_on:
      - postgres
    environment:
      DB_HOST: postgres
      DB_NAME: scraping
      DB_USER: scrape
      DB_PASS: scrape
    volumes:
      - ./models:/app/models  # Persistance modèles ML

  ###########################################################
  # ML API : expose le modèle pour prédictions
  ###########################################################
  ml_api:
    build: ./ml_api
    container_name: projetde_ml_api
    depends_on:
      - ml_trainer
    environment:
      MODEL_PATH: /app/models/model.pkl
    ports:
      - "8500:8500"  # Expose API externe
    volumes:
      - ./models:/app/models

  ###########################################################
  # API REST : expose les données de la DB
  ###########################################################
  api:
    build: ./api
    container_name: projetde_api
    depends_on:
      - postgres
    environment:
      DB_HOST: postgres
      DB_NAME: scraping
      DB_USER: scrape
      DB_PASS: scrape
    ports:
      - "8000:8000"  # Expose API externe

###########################################################
# Notes volumes :
# - ./data/xml_listes : XML téléchargés par scraper_liste_html
# - ./data/xml_types_vehicules : XML détaillés
# - ./postgres_data : fichiers PostgreSQL persistants
# - ./models : modèles ML sauvegardés
# Les bind mounts favorisent la portabilité et l’accès direct
# aux fichiers depuis la machine hôte.
###########################################################

# Aucun volume nommé utilisé ici : tout est bind mount pour portabilité
