version: "3.9"

services:

  ###########################################################
  # PostgreSQL : base de données pour stocker les données #
  ###########################################################
  postgres:
    image: postgres:15
    container_name: projetde_postgres
    environment:
      POSTGRES_DB: scraping
      POSTGRES_USER: scrape
      POSTGRES_PASSWORD: scrape
    ports:
      - "5432:5432"
    volumes:
      - ./postgres_data:/var/lib/postgresql/data   # volume local pour persistance

  ###########################################################
  # RabbitMQ : broker pour communication asynchrone       #
  ###########################################################
  rabbitmq:
    image: rabbitmq:3-management
    container_name: projetde_rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: user
      RABBITMQ_DEFAULT_PASS: pass
    ports:
      - "5672:5672"       # Port pour les microservices
      - "15672:15672"     # Management UI

  ###########################################################
  # Scraper HTML principal : récupère le lien du XML liste#
  ###########################################################
  scraper_liste_html:
    build: ./scraper_liste_html
    container_name: projetde_scraper_liste_html
    depends_on:
      - rabbitmq
    environment:
      RABBITMQ_HOST: rabbitmq

  ###########################################################
  # Parser liste XML : télécharge la liste et détecte MAJ #
  ###########################################################
  parser_liste_xml:
    build: ./parser_liste_xml
    container_name: projetde_parser_liste_xml
    depends_on:
      - rabbitmq
      - postgres
    environment:
      RABBITMQ_HOST: rabbitmq
      DB_HOST: postgres
      DB_NAME: scraping
      DB_USER: scrape
      DB_PASS: scrape
    volumes:
      - ./data/xml:/app/data/xml   # stockage local des XML

  ###########################################################
  # Scraper HTML type véhicule : récupère le lien XML détaillé#
  ###########################################################
  scraper_type_vehicule_html:
    build: ./scraper_type_vehicule_html
    container_name: projetde_scraper_type_vehicule_html
    depends_on:
      - rabbitmq
    environment:
      RABBITMQ_HOST: rabbitmq

  ###########################################################
  # Parser XML type véhicule : télécharge et parse XML    #
  ###########################################################
  parser_type_vehicule_xml:
    build: ./parser_type_vehicule_xml
    container_name: projetde_parser_type_vehicule_xml
    depends_on:
      - rabbitmq
    environment:
      RABBITMQ_HOST: rabbitmq
    volumes:
      - ./data/xml:/app/data/xml   # stockage local des XML

  ###########################################################
  # Ingest : insertion / mise à jour dans PostgreSQL      #
  ###########################################################
  ingest:
    build: ./ingest
    container_name: projetde_ingest
    depends_on:
      - rabbitmq
      - postgres
    environment:
      DB_HOST: postgres
      DB_NAME: scraping
      DB_USER: scrape
      DB_PASS: scrape
      RABBITMQ_HOST: rabbitmq
    volumes:
      - ./data/xml:/app/data/xml   # référence aux fichiers XML

  ###########################################################
  # Scheduler : planifie scraping et entraînement ML      #
  ###########################################################
  scheduler:
    build: ./scheduler
    container_name: projetde_scheduler
    depends_on:
      - scraper_liste_html
      - scraper_type_vehicule_html
      - ml_trainer
      - rabbitmq
    environment:
      RABBITMQ_HOST: rabbitmq

  ###########################################################
  # ML Trainer : entraînement du modèle ML                #
  ###########################################################
  ml_trainer:
    build: ./ml_trainer
    container_name: projetde_ml_trainer
    depends_on:
      - postgres
    environment:
      DB_HOST: postgres
      DB_NAME: scraping
      DB_USER: scrape
      DB_PASS: scrape
    volumes:
      - ./models:/app/models      # stockage local des modèles ML

  ###########################################################
  # ML API : API pour prédictions avec le modèle ML       #
  ###########################################################
  ml_api:
    build: ./ml_api
    container_name: projetde_ml_api
    depends_on:
      - ml_trainer
    environment:
      MODEL_PATH: /app/models/model.pkl
    ports:
      - "8500:8500"

  ###########################################################
  # API REST : exposer les données PostgreSQL             #
  ###########################################################
  api:
    build: ./api
    container_name: projetde_api
    depends_on:
      - postgres
    environment:
      DB_HOST: postgres
      DB_NAME: scraping
      DB_USER: scrape
      DB_PASS: scrape
    ports:
      - "8000:8000"
